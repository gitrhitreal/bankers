<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bonds</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg1:#74ABE2; --bg2:#5563DE;
      --card:#ffffff; --muted:#565a6c;
      --btn-bg: #5563DE; --btn-hover:#3340b8;
    }
    body{
      margin:0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:28px 16px;
      color:#222;
    }
    header{
      width:100%;
      max-width:1100px;
      margin-bottom:18px;
      background: rgba(255,255,255,0.12);
      padding:20px;
      border-radius:12px;
      color:#fff;
      text-align:center;
      font-size:22px;
      box-shadow:0 6px 18px rgba(0,0,0,0.18);
    }
    #bondList{
      width:100%;
      max-width:1100px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:18px;
    }
    .bond-card{
      background:var(--card);
      border-radius:12px;
      padding:18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      transition: transform .16s ease, box-shadow .16s ease;
    }
    .bond-card:hover{ transform:translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.18); }
    .bond-title{ font-size:18px; font-weight:700; margin-bottom:8px; color:#222; }
    .bond-details{ color:var(--muted); font-size:14px; margin:6px 0; }
    .btn-row{ margin-top:12px; display:flex; gap:8px; justify-content:center; }
    .approve-btn{
      padding:10px 12px; border-radius:10px; border:0; cursor:pointer; color:#fff;
      background:linear-gradient(135deg,var(--btn-bg),#764ba2); font-weight:700;
      transition: transform .12s ease, filter .12s ease;
    }
    .approve-btn:hover{ transform:scale(1.03); filter:brightness(.96); }
    .small { font-size:13px; color:#666; text-align:center; margin-top:8px; }
  </style>
</head>
<body>
  <header>Available Bonds</header>

  <div id="bondList">Loading bonds...</div>
  <div class="small">Click Buy to purchase — you will get a confirmation. (Purchases are logged to your Google Sheet.)</div>

  <script>
    // ← REPLACE this with your real Apps Script /exec URL
    const WEBAPP = "https://script.google.com/macros/s/AKfycbw9I9f5gYRiXXrhz6UhsFqf4-dw-uyAPoV68fjIZf3sieXrDD8wipiaT4oImjCLoBolIQ/exec";

    // helper: read bank name from localStorage (set at login)
    const BANK = localStorage.getItem("bankName") || localStorage.getItem("userId") || "";

    // load bonds from Bond_Portfolios (Apps Script doGet?action=getBonds should return objects with Bond Name, Current Price, Yield, Maturity, Bank, Status)
    async function loadBonds(){
      const list = document.getElementById("bondList");
      list.innerHTML = '<p style="color:#fff; grid-column:1/-1; text-align:center">Loading…</p>';
      try {
        const res = await fetch(WEBAPP + "?action=getBonds");
        const data = await res.json();
        // filter for bank and pending
        const visible = (Array.isArray(data) ? data : []).filter(b => {
          if (!b) return false;
          // Accept if Bank matches or if Bond_Portfolios is global (no Bank column)
          if (b.Bank && BANK) return String(b.Bank).trim() === String(BANK).trim() && (b.Status === "Pending" || !b.Status);
          // fallback: show pending only
          return (b.Status === "Pending" || !b.Status);
        });

        if (!visible.length){
          list.innerHTML = '<p style="color:#fff; grid-column:1/-1; text-align:center">No bonds available.</p>';
          return;
        }

        list.innerHTML = "";
        visible.forEach(bond=>{
          const card = document.createElement("div");
          card.className = "bond-card";
          const price = bond["Current Price"] ?? bond["Price"] ?? "";
          const yieldVal = bond["Yield"] ?? bond["Yield (%)"] ?? bond["Yield%"] ?? "";
          const maturity = bond["Maturity"] ?? bond["Maturity Date"] ?? "";

          card.innerHTML = `
            <div class="bond-title">${escapeHtml(bond["Bond Name"] ?? bond["Name"] ?? "Unnamed")}</div>
            <div class="bond-details"><strong>Price:</strong> ${escapeHtml(String(price))}</div>
            <div class="bond-details"><strong>Yield:</strong> ${escapeHtml(String(yieldVal))}</div>
            <div class="bond-details"><strong>Maturity:</strong> ${escapeHtml(String(maturity))}</div>
            <div class="btn-row">
              <button class="approve-btn">Buy</button>
            </div>
          `;
          // Buy handler — uses no-cors to avoid preflight CORS blocking
          card.querySelector(".approve-btn").addEventListener("click", ()=>{
            buyBond(String(bond["Bond Name"] || bond["Name"]), price);
          });
          list.appendChild(card);
        });
      } catch (err) {
        console.error("Failed loading bonds:", err);
        list.innerHTML = '<p style="color:#fff; grid-column:1/-1; text-align:center">Error loading bonds.</p>';
      }
    }

    // send purchase — note: using mode: "no-cors" — server side will still get this POST
    function buyBond(bondName, currentPrice){
      const qty = prompt(`Enter quantity to buy for "${bondName}":`, "1");
      if (!qty) return;
      // Construct payload
      const payload = {
        action: "buyBond",
        user: BANK || localStorage.getItem("userId") || "",
        bond: bondName,
        currentPrice: currentPrice || "",
        quantity: qty
      };

      // POST silently using no-cors to avoid the CORS preflight error from blocking the request.
      fetch(WEBAPP, {
        method: "POST",
        mode: "no-cors",            // << important: prevents CORS preflight blocking in browser
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      // We cannot read the response due to no-cors; show local confirmation & refresh
      alert(`✅ Purchase sent for ${qty} × ${bondName}`);
      // small delay to allow Apps Script to write; user can also refresh manually
      setTimeout(()=> location.reload(), 700);
    }

    // small utility to avoid injection in text nodes
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'", "&#039;");
    }

    // bootstrap
    loadBonds();
  </script>
</body>
</html>
