<script>
  const webAppUrl = "https://script.google.com/macros/s/AKfycbw9I9f5gYRiXXrhz6UhsFqf4-dw-uyAPoV68fjIZf3sieXrDD8wipiaT4oImjCLoBolIQ/exec";

  document.addEventListener("DOMContentLoaded", function() {
    const equityList = document.getElementById("equityList");
    const bankName = localStorage.getItem("bankName"); // current logged-in bank

    fetch(webAppUrl + "?action=getEquities&bank=" + encodeURIComponent(bankName))
      .then(res => res.json())
      .then(equities => {
        equityList.innerHTML = "";
        equities.forEach(eq => {
          const card = document.createElement("div");
          card.className = "equity-card";
          card.innerHTML = `
            <div class="equity-title">${eq["Equity Name"]}</div>
            <div class="equity-details">Price: ${eq["Current Price"]}</div>
            <button class="action-btn buy">Buy</button>
            <button class="action-btn sell">Sell</button>
          `;
          card.querySelector(".buy").onclick = () => tradeEquity(eq["Equity Name"], eq["Current Price"], "Buy");
          card.querySelector(".sell").onclick = () => tradeEquity(eq["Equity Name"], eq["Current Price"], "Sell");
          equityList.appendChild(card);
        });
      })
      .catch(err => {
        console.error(err);
        equityList.innerHTML = "<p style='color:white;'>Error loading equities.</p>";
      });
  });

  function tradeEquity(name, price, type) {
    const qty = prompt(`Enter quantity to ${type}:`);
    if (!qty || isNaN(qty)) return alert("Invalid quantity!");
    const userId = localStorage.getItem("bankName");

    fetch(webAppUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "tradeEquity",
        user: userId,
        equity: name,
        currentPrice: price,
        quantity: qty,
        tradeType: type
      })
    })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert(`${type} order placed for ${qty} of ${name}`);
        window.location.href = "dashboard.html";
      } else {
        alert("Error placing trade");
      }
    })
    .catch(err => {
      console.error("Trade error:", err);
      alert("Error placing trade: " + err);
    });
  }
</script>
